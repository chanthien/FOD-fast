<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detection Results</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/style.css') }}">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
</head>
<body>
    <div id="container">
        <div id="map-container">
            <div id="map"></div>
        </div>
        <div id="info-container">
            <div id="object-info">
                <h3>Detected Objects</h3>
                <div id="object-list"></div>
            </div>
            <div id="video-feed">
                <img id="video" src="{{ url_for('video_feed') }}" alt="Video feed">
            </div>
        </div>
    </div>

    <script>
        // Initialize map
        const map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        const markers = {};
        const objectList = document.getElementById('object-list');

        // WebSocket connection
        const socket = new WebSocket('ws://' + window.location.host + '/ws');

        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            updateMapAndInfo(data.detections);
        };

        function updateMapAndInfo(detections) {
            // Clear existing markers and info
            for (let id in markers) {
                map.removeLayer(markers[id]);
            }
            objectList.innerHTML = '';

            // Add new markers and update info
            detections.forEach((det, index) => {
                const marker = L.marker([det.lat, det.lon]).addTo(map);
                marker.bindPopup(`${det.name} (${det.confidence.toFixed(2)})`);
                markers[index] = marker;

                const infoElement = document.createElement('div');
                infoElement.className = 'object-item';
                infoElement.innerHTML = `
                    <strong>${det.name}</strong> (${det.confidence.toFixed(2)})<br>
                    Lat: ${det.lat.toFixed(6)}, Lon: ${det.lon.toFixed(6)}
                `;
                objectList.appendChild(infoElement);
            });

            // Fit map bounds to show all markers
            if (Object.keys(markers).length > 0) {
                const group = new L.featureGroup(Object.values(markers));
                map.fitBounds(group.getBounds());
            }
        }

        // Expand video feed on click
        const videoFeed = document.getElementById('video-feed');
        videoFeed.addEventListener('click', function() {
            this.classList.toggle('fullscreen');
        });
    </script>
</body>
</html>