<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Object Detection Results</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body { padding-top: 20px; }
        #video-container { position: relative; }
        #video-feed { max-width: 100%; height: auto; }
        #overlay { position: absolute; top: 0; left: 0; }
        #map { height: 500px; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">Object Detection Results</h1>

        <div class="row">
            <div class="col-md-6">
                <h2>Video Feed</h2>
                <div id="video-container">
                    <img id="video-feed" src="{{ url_for('video_feed') }}" alt="Video Feed">
                    <canvas id="overlay"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <h2>Map View</h2>
                <div id="map"></div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <h2>Detected Objects:</h2>
                <ul id="detections" class="list-group"></ul>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        const ws = new WebSocket("ws://" + window.location.host + "/ws");
        const detectionsList = document.getElementById("detections");
        const videoFeed = document.getElementById("video-feed");
        const overlay = document.getElementById("overlay");
        const ctx = overlay.getContext("2d");

        // Initialize map
        const map = L.map('map').setView([21.0050, 105.8441], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);
        const markers = {};

        function updateOverlay() {
            overlay.width = videoFeed.width;
            overlay.height = videoFeed.height;
        }

        videoFeed.onload = updateOverlay;
        window.onresize = updateOverlay;

        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            detectionsList.innerHTML = "";
            ctx.clearRect(0, 0, overlay.width, overlay.height);

            // Process video detections
            data.video.forEach((det, index) => {
                // Draw bounding box
                const [x1, y1, x2, y2] = det.bbox;
                ctx.strokeStyle = `hsl(${index * 137.5 % 360}, 100%, 50%)`;
                ctx.lineWidth = 2;
                ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);

                // Draw label
                ctx.fillStyle = `hsl(${index * 137.5 % 360}, 100%, 50%)`;
                ctx.font = "12px Arial";
                ctx.fillText(`${det.name} (${det.confidence.toFixed(2)})`, x1, y1 > 20 ? y1 - 5 : y1 + 15);
            });

            // Process GPS detections
            data.gps.forEach((det, index) => {
                // Update list
                const li = document.createElement("li");
                li.className = "list-group-item";
                li.innerHTML = `
                    <strong>${det.name}</strong><br>
                    Confidence: ${det.confidence.toFixed(2)}<br>
                    Lat: ${det.lat.toFixed(6)}, Lon: ${det.lon.toFixed(6)}
                `;
                detectionsList.appendChild(li);

                // Update map
                if (markers[det.name]) {
                    markers[det.name].setLatLng([det.lat, det.lon]);
                } else {
                    markers[det.name] = L.marker([det.lat, det.lon]).addTo(map)
                        .bindPopup(`${det.name} (${det.confidence.toFixed(2)})`);
                }
            });
        };
    </script>

</body>
</html>